name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Audit dependencies
        # 보안 취약점이 발견되면 빌드를 실패하게 하여 배포를 막습니다. (audit-level은 상황에 맞게 조절 가능: moderate, high, critical)
        run: npm audit --audit-level=critical

      - name: Build Next.js application
        run: npm run build
        env:
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_KAKAO_MAP_API_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_MAP_API_KEY }}
          NEXT_PUBLIC_COMPANY_ADDRESS: ${{ vars.NEXT_PUBLIC_COMPANY_ADDRESS }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SKIP_DB_QUERIES: "true"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.DEPLOY_AWS_REGION }}

      - name: Create ecosystem.config.js file
        run: |
          cat > ecosystem.config.js << 'ECOSYSTEM'
          module.exports = {
            apps: [{
              name: 'tov-app',
              script: 'npm',
              args: 'start',
              instances: 1,
              exec_mode: 'fork',
              autorestart: true,
              watch: false,
              max_memory_restart: '800M',
              min_uptime: '10s',
              max_restarts: 10,
              env: {
                NODE_ENV: 'production',
                PORT: 3000
              }
            }]
          };
          ECOSYSTEM

      - name: Install production dependencies
        run: npm ci --omit=dev

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r .next deploy-package/
          cp -r public deploy-package/ 2>/dev/null || echo "No public directory"
          cp -r node_modules deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          cp ecosystem.config.js deploy-package/
          cp next.config.js deploy-package/
          tar -czf deploy-package.tar.gz deploy-package/

      - name: Upload to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          aws s3 cp deploy-package.tar.gz s3://${{ secrets.DEPLOY_S3_BUCKET_NAME }}/production/deploy-${TIMESTAMP}.tar.gz
          aws s3 cp deploy-package.tar.gz s3://${{ secrets.DEPLOY_S3_BUCKET_NAME }}/production/latest.tar.gz

      - name: Setup SSH keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/bastion_key
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/bastion_key ~/.ssh/ec2_key

      - name: Deploy to EC2 via Bastion
        env:
          S3_BUCKET_NAME: ${{ secrets.DEPLOY_S3_BUCKET_NAME }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_ACCESS_SECRET: ${{ vars.JWT_ACCESS_SECRET }}
          JWT_REFRESH_SECRET: ${{ vars.JWT_REFRESH_SECRET }}
        run: |
          SSH_COMMAND="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30"

          $SSH_COMMAND -i ~/.ssh/ec2_key \
            -o ProxyCommand="$SSH_COMMAND -i ~/.ssh/bastion_key -W %h:%p ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }}" \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_PRIVATE_IP }} bash << 'DEPLOY_SCRIPT'

          # 환경 변수
          S3_BUCKET_NAME="${{ secrets.DEPLOY_S3_BUCKET_NAME }}/production"
          APP_DIR="/apps/tov-homepage"
          PM2_APP_NAME="tov-app"

          echo "Starting deployment from S3..."

          # Node.js 경로 확인
          NODE_PATH=$(which node)
          echo "Node.js path: $NODE_PATH"

          # PM2 설치 확인
          if ! command -v pm2 &> /dev/null; then
            echo "PM2 not found, installing..."
            npm install -g pm2
          fi

          # 디렉토리 생성
          sudo mkdir -p $APP_DIR
          cd $APP_DIR

          # S3에서 다운로드
          AWS_ACCESS_KEY_ID="${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}" \
          AWS_SECRET_ACCESS_KEY="${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}" \
          AWS_DEFAULT_REGION="${{ secrets.DEPLOY_AWS_REGION }}" \
          aws s3 cp s3://${S3_BUCKET_NAME}/latest.tar.gz ./

          # PM2 앱 중지 및 삭제 (배포 전)
          pm2 delete $PM2_APP_NAME || true
          pm2 delete all || true
          pm2 kill

          # 디스크 공간 확보 - 3일 이상 된 백업 삭제
          find /apps/tov-homepage -name "backup-*" -type d -mtime +3 -exec rm -rf {} + 2>/dev/null || true

          # 백업
          if [ -d "current" ]; then
            sudo mv current backup-$(date +%Y%m%d%H%M%S)
          fi

          # 압축 해제
          sudo tar -xzf latest.tar.gz
          sudo mv deploy-package current
          sudo rm latest.tar.gz

          # 권한 설정
          sudo chown -R $USER:$USER $APP_DIR/current

          cd $APP_DIR/current

          # 환경변수 파일 생성
          cat > .env << ENVFILE
          NODE_ENV=production
          PORT=3000
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          DATABASE_HOST=${{ secrets.DATABASE_HOST }}
          DATABASE_PORT=${{ secrets.DATABASE_PORT }}
          DATABASE_USER=${{ secrets.DATABASE_USER }}
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
          DATABASE_NAME=${{ secrets.DATABASE_NAME }}
          JWT_ACCESS_SECRET=${{ vars.JWT_ACCESS_SECRET }}
          JWT_REFRESH_SECRET=${{ vars.JWT_REFRESH_SECRET }}
          NEXT_PUBLIC_KAKAO_MAP_API_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_MAP_API_KEY }}
          NEXT_PUBLIC_COMPANY_ADDRESS=${{ vars.NEXT_PUBLIC_COMPANY_ADDRESS }}
          NEXT_PUBLIC_APP_URL=${{ vars.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL }}

          # AWS S3 Configuration
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}

          # S3 Bucket Configuration (set to 'false' for private bucket with pre-signed URLs)
          AWS_S3_BUCKET_IS_PUBLIC=${{ secrets.AWS_S3_BUCKET_IS_PUBLIC }}

          # Next.js Configuration
          NEXT_PUBLIC_S3_BUCKET_URL=${{ vars.NEXT_PUBLIC_S3_BUCKET_URL }}

          # Gmail 설정
          EMAIL_SERVICE=${{ vars.EMAIL_SERVICE }}
          EMAIL_USER=${{ vars.EMAIL_USER }}
          EMAIL_PASS=${{ vars.EMAIL_PASS }}
          EMAIL_FROM=${{ vars.EMAIL_FROM }}

          ENVFILE

          # PM2로 앱 시작
          pm2 start ecosystem.config.js

          # PM2 startup 설정 (서버 재시작 시 자동 실행)
          pm2 save
          sudo env PATH=$PATH:$(which node | xargs dirname) pm2 startup systemd -u $USER --hp /home/$USER || true

          # 상태 확인
          sleep 5
          pm2 status

          # 헬스체크
          sleep 2
          curl -f http://localhost:3000/health || curl -f http://localhost:3000 || echo "Health check not ready yet"

          echo "Deployment completed!"

          DEPLOY_SCRIPT

      - name: Clean up SSH keys
        if: always()
        run: |
          rm -f ~/.ssh/bastion_key ~/.ssh/ec2_key

      - name: Verify deployment
        run: |
          echo "Deployment completed. Please check https://tov.ptax.kr manually."

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi
